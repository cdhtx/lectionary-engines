{% extends "base.html" %}

{% block title %}Generate Study | Lectionary Engines{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Generate Study</h1>
        <p>Create a new biblical interpretation study using one of the three engines</p>
    </div>

    <form method="POST" action="/generate" class="generate-form" id="generateForm">
        <div class="form-section">
            <h2>1. Choose an Engine</h2>
            <div class="radio-group">
                <label class="radio-card">
                    <input type="radio" name="engine" value="threshold" {% if default_engine == 'threshold' %}checked{% endif %} required>
                    <div class="radio-content">
                        <strong>Threshold</strong>
                        <p>Four progressive thresholds + tech touchpoint (2,500-3,500 words)</p>
                    </div>
                </label>

                <label class="radio-card">
                    <input type="radio" name="engine" value="palimpsest" {% if default_engine == 'palimpsest' %}checked{% endif %}>
                    <div class="radio-content">
                        <strong>Palimpsest</strong>
                        <p>Five hermeneutical layers using PaRDeS (3,000-4,000 words)</p>
                    </div>
                </label>

                <label class="radio-card">
                    <input type="radio" name="engine" value="collision" {% if default_engine == 'collision' %}checked{% endif %}>
                    <div class="radio-content">
                        <strong>Collision</strong>
                        <p>Five-step collision with randomizer (3,000-5,000 words)</p>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-section">
            <h2>2. Select Your Profile</h2>

            <div class="form-group">
                <label for="profile-select">User Profile</label>
                <select id="profile-select" name="profile_id" class="form-select">
                    <option value="">Loading profiles...</option>
                </select>
                <p class="help-text">Choose a profile to customize study length, tone, and language complexity</p>
            </div>

            <div id="profile-info" class="profile-info" style="display: none;">
                <div class="profile-details">
                    <h3 id="profile-name">Default</h3>
                    <p id="profile-description"></p>
                    <ul class="profile-specs">
                        <li><strong>Length:</strong> <span id="profile-length"></span></li>
                        <li><strong>Tone:</strong> <span id="profile-tone"></span></li>
                        <li><strong>Language:</strong> <span id="profile-language"></span></li>
                        <li id="profile-focus-item" style="display: none;"><strong>Focus:</strong> <span id="profile-focus"></span></li>
                    </ul>
                </div>
            </div>

            <details class="custom-preferences">
                <summary>Customize for This Study</summary>
                <div class="preferences-content">
                    <p class="help-text">Override profile settings for this study only. Leave blank to use profile defaults.</p>

                    <div class="form-group">
                        <label>Study Length</label>
                        <div class="radio-group-inline">
                            <label class="radio-inline">
                                <input type="radio" name="custom_study_length" value="short">
                                <span>Short (1000-1500 words)</span>
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="custom_study_length" value="medium">
                                <span>Medium (2500-3500 words)</span>
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="custom_study_length" value="long">
                                <span>Long (5000-7000 words)</span>
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="custom_study_length" value="" checked>
                                <span>Use Profile Default</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tone-slider">
                            Tone: <span id="tone-label">Balanced (5)</span>
                        </label>
                        <div class="tone-slider-container">
                            <span class="tone-label-left">Academic</span>
                            <input
                                type="range"
                                id="tone-slider"
                                name="custom_tone_level"
                                min="-1"
                                max="8"
                                value="-1"
                                class="tone-slider">
                            <span class="tone-label-right">Devotional</span>
                        </div>
                        <div class="tone-scale">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span>
                        </div>
                        <p class="help-text">Set to -1 to use profile default</p>
                    </div>

                    <div class="form-group">
                        <label for="language-select">Language Complexity</label>
                        <select id="language-select" name="custom_language_complexity" class="form-select">
                            <option value="">Use Profile Default</option>
                            <option value="accessible">Accessible (High school level)</option>
                            <option value="standard">Standard (College level)</option>
                            <option value="advanced">Advanced (Graduate level)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="focus-areas">Focus Areas</label>
                        <textarea
                            id="focus-areas"
                            name="custom_focus_areas"
                            rows="3"
                            class="form-textarea"
                            placeholder="e.g., social justice, personal growth, historical context"></textarea>
                        <p class="help-text">Specify themes or interests to emphasize (leave blank to use profile default)</p>
                    </div>

                    <div class="form-group">
                        <label for="artifacts-slider">
                            Cultural Artifacts: <span id="artifacts-label">Off</span>
                        </label>
                        <div class="artifacts-slider-container">
                            <span class="artifacts-label-left">Off</span>
                            <input
                                type="range"
                                id="artifacts-slider"
                                name="custom_cultural_artifacts_level"
                                min="0"
                                max="10"
                                value="0"
                                class="artifacts-slider">
                            <span class="artifacts-label-right">Rich</span>
                        </div>
                        <div class="artifacts-scale">
                            <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
                        </div>
                        <p class="help-text">Weave cultural references (news, music, film, books, podcasts, etc.) throughout the study to illuminate scripture</p>
                    </div>
                </div>
            </details>
        </div>

        <div class="form-section">
            <h2>3. Choose Text Source</h2>

            <div class="source-tabs">
                <label class="source-tab">
                    <input type="radio" name="source" value="paste" checked>
                    <span>Paste Text</span>
                </label>
                <label class="source-tab">
                    <input type="radio" name="source" value="run">
                    <span>Bible Gateway</span>
                </label>
                <label class="source-tab">
                    <input type="radio" name="source" value="moravian">
                    <span>Moravian Daily Text</span>
                </label>
                <label class="source-tab">
                    <input type="radio" name="source" value="rcl">
                    <span>RCL</span>
                </label>
            </div>

            <!-- Paste Source Fields -->
            <div id="source-paste" class="source-fields">
                <div class="form-group">
                    <label for="reference-paste">Biblical Reference</label>
                    <input
                        type="text"
                        id="reference-paste"
                        name="reference"
                        placeholder="e.g., John 3:16-21"
                        class="form-input">
                    <p class="help-text">Enter the biblical reference (e.g., "Mark 5:1-5", "Romans 8:18-30")</p>
                </div>

                <div class="form-group">
                    <label for="text">Biblical Text</label>
                    <textarea
                        id="text"
                        name="text"
                        rows="10"
                        class="form-textarea"
                        placeholder="Paste your biblical text here"></textarea>
                    <p class="help-text">Paste the biblical text you want to interpret</p>
                </div>
            </div>

            <!-- Bible Gateway Source Fields -->
            <div id="source-run" class="source-fields" style="display: none;">
                <div class="form-group">
                    <label for="reference-run">Biblical Reference</label>
                    <input
                        type="text"
                        id="reference-run"
                        name="reference"
                        placeholder="e.g., John 3:16-21"
                        class="form-input">
                    <p class="help-text">The text will be automatically fetched from Bible Gateway</p>
                </div>

                <div class="form-group">
                    <label for="translation">Translation</label>
                    <select id="translation" name="translation" class="form-select">
                        {% for trans in translations %}
                        <option value="{{ trans }}" {% if trans == default_translation %}selected{% endif %}>{{ trans }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Moravian Source Fields -->
            <div id="source-moravian" class="source-fields" style="display: none;">
                <div class="info-box">
                    <h3>Today's Moravian Daily Text</h3>
                    <p>Automatically fetches all readings from today's Moravian Daily Text (Daily Psalm, OT/NT readings, Watchword, and Daily Text)</p>
                </div>

                <div class="form-group">
                    <label for="translation-moravian">Translation</label>
                    <select id="translation-moravian" name="translation" class="form-select">
                        {% for trans in translations %}
                        <option value="{{ trans }}" {% if trans == default_translation %}selected{% endif %}>{{ trans }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- RCL Source Fields -->
            <div id="source-rcl" class="source-fields" style="display: none;">
                <div class="info-box">
                    <h3>Revised Common Lectionary</h3>
                    <p>Fetches today's reading from the Revised Common Lectionary (daily readings from Vanderbilt Divinity Library)</p>
                </div>

                <div class="form-group">
                    <label for="rcl-reading">Reading Type</label>
                    <select id="rcl-reading" name="rcl_reading" class="form-select">
                        <option value="gospel" selected>Gospel</option>
                        <option value="ot">Old Testament</option>
                        <option value="psalm">Psalm</option>
                        <option value="epistle">Epistle</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="translation-rcl">Translation</label>
                    <select id="translation-rcl" name="translation" class="form-select">
                        {% for trans in translations %}
                        <option value="{{ trans }}" {% if trans == default_translation %}selected{% endif %}>{{ trans }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                Generate Study
            </button>
            <p class="help-text">
                <strong>Estimated time:</strong>
                <span id="timeEstimate">30-60 seconds</span>
            </p>
        </div>
    </form>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <h2>Generating Study...</h2>
            <p id="loadingMessage">This may take 30-60 seconds. Please wait...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ============================================================================
// Profile Management
// ============================================================================

let profiles = [];
let selectedProfile = null;

// Load profiles on page load
async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles');
        const data = await response.json();
        profiles = data.profiles;

        const select = document.getElementById('profile-select');
        select.innerHTML = '';

        profiles.forEach(function(profile) {
            const option = document.createElement('option');
            option.value = profile.id;
            option.textContent = profile.name;
            if (profile.is_default) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // Load default profile
        if (profiles.length > 0) {
            const defaultProfile = profiles.find(p => p.is_default) || profiles[0];
            loadProfile(defaultProfile.id);
        }
    } catch (error) {
        console.error('Failed to load profiles:', error);
        document.getElementById('profile-select').innerHTML = '<option value="">Error loading profiles</option>';
    }
}

// Load and display a specific profile
function loadProfile(profileId) {
    const profile = profiles.find(p => p.id == profileId);
    if (!profile) return;

    selectedProfile = profile;

    // Update profile info display
    document.getElementById('profile-name').textContent = profile.name;
    document.getElementById('profile-description').textContent = profile.description || '';

    // Format length display
    const lengthMap = {
        'short': 'Short (1000-1500 words)',
        'medium': 'Medium (2500-3500 words)',
        'long': 'Long (5000-7000 words)'
    };
    document.getElementById('profile-length').textContent = lengthMap[profile.study_length];

    // Format tone display
    const toneCategory = profile.tone_level <= 2 ? 'Academic' :
                         profile.tone_level <= 5 ? 'Balanced' : 'Devotional';
    document.getElementById('profile-tone').textContent = `${toneCategory} (${profile.tone_level}/8)`;

    // Format language display
    const languageMap = {
        'accessible': 'Accessible (High school)',
        'standard': 'Standard (College)',
        'advanced': 'Advanced (Graduate)'
    };
    document.getElementById('profile-language').textContent = languageMap[profile.language_complexity];

    // Show/hide focus areas
    if (profile.focus_areas) {
        document.getElementById('profile-focus').textContent = profile.focus_areas;
        document.getElementById('profile-focus-item').style.display = 'list-item';
    } else {
        document.getElementById('profile-focus-item').style.display = 'none';
    }

    // Show profile info
    document.getElementById('profile-info').style.display = 'block';
}

// Profile selector change handler
document.getElementById('profile-select').addEventListener('change', function() {
    loadProfile(this.value);
});

// Initialize profiles on page load
loadProfiles();

// ============================================================================
// Tone Slider
// ============================================================================

const toneSlider = document.getElementById('tone-slider');
const toneLabel = document.getElementById('tone-label');

function updateToneLabel(value) {
    if (value == -1) {
        toneLabel.textContent = 'Use Profile Default';
        return;
    }

    const val = parseInt(value);
    let category = '';
    if (val <= 2) category = 'Academic';
    else if (val <= 5) category = 'Balanced';
    else category = 'Devotional';

    toneLabel.textContent = `${category} (${val})`;
}

toneSlider.addEventListener('input', function() {
    updateToneLabel(this.value);
});

// Initialize tone label
updateToneLabel(toneSlider.value);

// ============================================================================
// Cultural Artifacts Slider
// ============================================================================

const artifactsSlider = document.getElementById('artifacts-slider');
const artifactsLabel = document.getElementById('artifacts-label');

function updateArtifactsLabel(value) {
    const val = parseInt(value);
    if (val === 0) {
        artifactsLabel.textContent = 'Off';
    } else if (val <= 3) {
        artifactsLabel.textContent = `Occasional (${val})`;
    } else if (val <= 6) {
        artifactsLabel.textContent = `Moderate (${val})`;
    } else {
        artifactsLabel.textContent = `Rich (${val})`;
    }
}

artifactsSlider.addEventListener('input', function() {
    updateArtifactsLabel(this.value);
});

// Initialize artifacts label
updateArtifactsLabel(artifactsSlider.value);

// ============================================================================
// Form Submission & Loading
// ============================================================================

// Show loading overlay when form is submitted
document.getElementById('generateForm').addEventListener('submit', function(e) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('submitBtn').disabled = true;
});

// Update time estimate based on engine selection
document.querySelectorAll('input[name="engine"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const engine = this.value;
        const timeEstimate = document.getElementById('timeEstimate');
        const loadingMessage = document.getElementById('loadingMessage');

        if (engine === 'threshold') {
            timeEstimate.textContent = '30-60 seconds';
            loadingMessage.textContent = 'This may take 30-60 seconds. Please wait...';
        } else if (engine === 'palimpsest') {
            timeEstimate.textContent = '60-90 seconds';
            loadingMessage.textContent = 'This may take 60-90 seconds. Please wait...';
        } else if (engine === 'collision') {
            timeEstimate.textContent = '90-120 seconds';
            loadingMessage.textContent = 'This may take 90-120 seconds. Please wait...';
        }
    });
});

// ============================================================================
// Source Tab Switching
// ============================================================================

// Source tab switching
document.querySelectorAll('input[name="source"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const source = this.value;

        // Hide all source fields
        document.querySelectorAll('.source-fields').forEach(function(field) {
            field.style.display = 'none';
        });

        // Show selected source fields
        document.getElementById('source-' + source).style.display = 'block';

        // Clear reference fields to avoid confusion
        document.querySelectorAll('input[name="reference"]').forEach(function(input) {
            input.required = false;
        });

        // Set required for active source
        if (source === 'paste' || source === 'run') {
            const activeRef = document.querySelector('#source-' + source + ' input[name="reference"]');
            if (activeRef) activeRef.required = true;
        }

        // Handle text field requirement
        if (source === 'paste') {
            document.getElementById('text').required = true;
        } else {
            document.getElementById('text').required = false;
        }
    });
});
</script>
{% endblock %}
